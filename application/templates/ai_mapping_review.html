{% extends "layouts/base-fullscreen.html" %}

{% block title %} Review AI-Generated Mappings {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<style>
    .mapping-card {
        border-left: 5px solid #ced4da;
        transition: all 0.2s ease-in-out;
    }
    .mapping-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .mapping-card.high-confidence {
        border-left-color: #10B981;
    }
    .mapping-card.medium-confidence {
        border-left-color: #FBBF24;
    }
    .mapping-card.low-confidence {
        border-left-color: #F87171;
    }
    .confidence-badge {
        font-size: 0.8rem;
        padding: 0.25em 0.6em;
    }
    .table-container {
        max-height: 500px;
        overflow-y: auto;
    }
    .separator {
        display: flex;
        align-items: center;
        text-align: center;
        color: #6B7280;
    }
    .separator::before,
    .separator::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #E5E7EB;
    }
    .separator:not(:empty)::before {
        margin-right: 1em;
    }
    .separator:not(:empty)::after {
        margin-left: 1em;
    }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="bg-white shadow border-0 rounded p-4 p-lg-5 w-100">
                <div class="text-center text-md-center mb-4 mt-md-0">
                    <h1 class="mb-0 h3">Review AI-Generated Mappings</h1>
                    <p class="mb-0">
                        Standard: <strong>{{ results.standard }}</strong>
                    </p>
                    <p class="text-muted">
                        {{ results.summary.mapped_count }} mapped controls, 
                        {{ results.summary.unmapped_count }} unmapped controls
                    </p>
                </div>

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- Summary Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3 mb-md-0">
                                <h5 class="mb-0 text-success">{{ results.summary.high_confidence_count }}</h5>
                                <p class="mb-0 text-muted">High Confidence</p>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <h5 class="mb-0 text-warning">{{ results.summary.requires_review_count }}</h5>
                                <p class="mb-0 text-muted">Needs Review</p>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <h5 class="mb-0 text-danger">{{ results.summary.unmapped_count }}</h5>
                                <p class="mb-0 text-muted">Unmapped</p>
                            </div>
                            <div class="col-md-3">
                                <h5 class="mb-0 text-info">{{ results.suggested_new_cres|length }}</h5>
                                <p class="mb-0 text-muted">Suggested CREs</p>
                            </div>
                        </div>
                    </div>
                </div>

                <form action="/myopencre/ai-map/confirm" method="post" class="mt-4">
                    <!-- Mapped Controls Section -->
                    <h4 class="mb-3">Mapped Controls</h4>
                    <p class="text-muted mb-4">Review and approve the AI-generated mappings between controls and CREs.</p>

                    {% if results.mapped_controls %}
                        <div class="table-container mb-4">
                            {% for mapping in results.mapped_controls %}
                                {% set confidence_class = "high-confidence" if mapping.confidence >= 0.8 else "medium-confidence" if mapping.confidence >= 0.6 else "low-confidence" %}
                                {% set confidence_text = "High" if mapping.confidence >= 0.8 else "Medium" if mapping.confidence >= 0.6 else "Low" %}
                                {% set confidence_bg = "success" if mapping.confidence >= 0.8 else "warning" if mapping.confidence >= 0.6 else "danger" %}
                                
                                <div class="card mapping-card mb-3 {{ confidence_class }}">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-6">
                                                <h5 class="card-title mb-1">{{ mapping.control.name }}</h5>
                                                <p class="text-muted small mb-2">{{ mapping.control.id }}</p>
                                                <p class="mb-0">{{ mapping.control.description|truncate(150) }}</p>
                                            </div>
                                            
                                            <div class="col-md-1 text-center my-3 my-md-0">
                                                <i class="fas fa-arrow-right"></i>
                                            </div>
                                            
                                            <div class="col-md-5">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="card-title mb-0">{{ mapping.cre.name }}</h5>
                                                    <span class="badge bg-{{ confidence_bg }} confidence-badge">
                                                        {{ confidence_text }} ({{ "%.2f"|format(mapping.confidence) }})
                                                    </span>
                                                </div>
                                                <p class="text-muted small mb-2">{{ mapping.cre.id }}</p>
                                                <p class="mb-3">{{ mapping.cre.description|truncate(150) }}</p>
                                                
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="mapping_{{ loop.index0 }}" id="mapping_{{ loop.index0 }}" value="1"
                                                        {% if mapping.confidence >= 0.8 %} checked {% endif %}>
                                                    <label class="form-check-label" for="mapping_{{ loop.index0 }}">
                                                        Approve this mapping
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if mapping.reasoning %}
                                            <div class="mt-3 pt-3 border-top">
                                                <p class="mb-0 text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    <strong>AI Reasoning:</strong> {{ mapping.reasoning }}
                                                </p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-warning">No mappings were found for this standard.</div>
                    {% endif %}

                    <!-- Suggested New CREs Section -->
                    {% if results.suggested_new_cres %}
                        <div class="separator my-5">Suggested New CREs</div>
                        
                        <h4 class="mb-3">Suggested New CREs</h4>
                        <p class="text-muted mb-4">
                            The AI suggests creating the following new CREs for controls that couldn't be mapped.
                            Select which suggestions you want to save.
                        </p>

                        <div class="table-container mb-4">
                            {% for suggestion in results.suggested_new_cres %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="card-title mb-0">{{ suggestion.name }}</h5>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="suggestion_{{ loop.index0 }}" id="suggestion_{{ loop.index0 }}" value="1">
                                                <label class="form-check-label" for="suggestion_{{ loop.index0 }}">
                                                    Save this suggestion
                                                </label>
                                            </div>
                                        </div>
                                        <p class="mb-3">{{ suggestion.description }}</p>
                                        
                                        {% if suggestion.tags %}
                                            <div class="mb-2">
                                                {% for tag in suggestion.tags %}
                                                    <span class="badge bg-secondary me-1">{{ tag }}</span>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        
                                        {% if suggestion.potential_relationships %}
                                            <div class="mt-3 pt-3 border-top">
                                                <p class="mb-2 text-muted">
                                                    <strong>Potential Relationships:</strong>
                                                </p>
                                                <ul class="mb-0">
                                                    {% for rel in suggestion.potential_relationships %}
                                                        <li>{{ rel }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="d-flex justify-content-between mt-4">
                        <a href="/myopencre/ai-map" class="btn btn-secondary">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-2"></i>
                            Save Approved Mappings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enable tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
</script>
{% endblock javascripts %} 